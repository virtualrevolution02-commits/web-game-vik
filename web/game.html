<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Vistara Drive</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      overflow: hidden;
      background: transparent;
    }

    canvas {
      display: block;
      width: 100vw;
      height: 100vh;
    }
  </style>
</head>

<body>
  <canvas id="game-canvas"></canvas>
  <script src="https://unpkg.com/three@0.152.0/build/three.min.js"></script>
  <!-- MediaPipe dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>

  <style>
    #desktop-ui {
      position: absolute;
      top: 20px;
      left: 20px;
      background: transparent;
      padding: 15px;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 100;
      transition: all 0.3s ease;
      pointer-events: none;
    }

    #desktop-ui>* {
      pointer-events: auto;
    }

    .ui-title {
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      opacity: 0.5;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .btn-toggle {
      background: #3B76F6;
      border: none;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-toggle:hover {
      background: #2563EB;
    }

    .btn-toggle.active {
      background: #10B981;
    }

    #speed-container {
      font-size: 18px;
      font-weight: 700;
      color: #10B981;
      padding: 5px 0;
      border-top: 1px solid rgba(255, 255, 255, 0.1);
      margin-top: 5px;
      font-variant-numeric: tabular-nums;
      opacity: 0.5;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    #status-indicator {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      opacity: 0.5;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #EF4444;
    }

    .status-dot.active {
      background: #10B981;
    }

    #camera-preview {
      width: 100px;
      height: 75px;
      border-radius: 8px;
      overflow: hidden;
      background: #111;
      display: none;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .input-video {
      display: none;
    }

    .output-canvas {
      width: 100%;
      height: 100%;
      transform: scaleX(-1);
    }
  </style>

  <style>
    /* --- ONBOARDING UI --- */
    #onboarding-ui {
      position: absolute;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: transparent;
      z-index: 1000;
      display: flex;
      justify-content: center;
      align-items: center;
      color: white;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      transition: opacity 0.8s ease;
    }

    .glass-panel {
      background: rgba(255, 255, 255, 0.1);
      -webkit-backdrop-filter: blur(25px);
      backdrop-filter: blur(25px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 20px;
      padding: 40px;
      width: 400px;
      box-shadow: 0 25px 50px rgba(0, 0, 0, 0.5), inset 0 0 0 1px rgba(255, 255, 255, 0.1);
      display: none;
      flex-direction: column;
      align-items: center;
      text-align: center;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.5s ease;
    }

    .glass-panel.active {
      display: flex;
      opacity: 1;
      transform: translateY(0);
    }

    .ob-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
      background: linear-gradient(90deg, #10B981, #3B82F6);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .ob-subtitle {
      font-size: 14px;
      color: rgba(255, 255, 255, 0.6);
      margin-bottom: 30px;
    }

    .ob-input {
      width: 100%;
      background: rgba(0, 0, 0, 0.4);
      border: 1px solid rgba(255, 255, 255, 0.2);
      padding: 12px 15px;
      border-radius: 8px;
      color: #ffffff;
      margin-bottom: 15px;
      font-size: 14px;
      outline: none;
      transition: border 0.3s, background 0.3s;
    }

    .ob-input::placeholder {
      color: rgba(255, 255, 255, 0.6);
    }

    .ob-input:focus {
      border-color: #10B981;
      background: rgba(0, 0, 0, 0.6);
    }

    .ob-btn {
      width: 100%;
      background: linear-gradient(90deg, #10B981, #059669);
      border: none;
      padding: 14px;
      border-radius: 8px;
      color: white;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      margin-top: 10px;
      box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
      transition: transform 0.2s, box-shadow 0.2s;
    }

    .ob-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
    }

    .ob-link {
      margin-top: 20px;
      font-size: 13px;
      color: rgba(255, 255, 255, 0.5);
      cursor: pointer;
      transition: color 0.2s;
    }

    .ob-link:hover {
      color: #10B981;
    }

    .error-text {
      color: #ef4444;
      font-size: 13px;
      margin-top: 10px;
    }

    /* Loading Bar */
    .loading-bar-container {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 3px;
      overflow: hidden;
      margin-top: 20px;
    }

    .loading-bar {
      width: 0%;
      height: 100%;
      background: #10B981;
      transition: width 0.3s ease;
    }
  </style>

  <!-- ONBOARDING OVERLAY -->
  <div id="onboarding-ui">

    <!-- LOADING SCREEN -->
    <div id="screen-loading" class="glass-panel active">
      <div class="ob-title">Vistara Tech</div>
      <div class="ob-subtitle">Initializing World...</div>
      <div class="loading-bar-container">
        <div id="loading-progress" class="loading-bar"></div>
      </div>
    </div>

    <!-- SIGN IN SCREEN -->
    <div id="screen-signin" class="glass-panel">
      <div class="ob-title">Welcome Back</div>
      <div class="ob-subtitle">Sign in to sync your progress</div>
      <input type="email" id="signin-email" class="ob-input" placeholder="Email Address">
      <input type="password" id="signin-password" class="ob-input" placeholder="Password">
      <button class="ob-btn" onclick="signIn()">Play Game</button>
      <div class="ob-link" onclick="switchScreen('screen-signup')">Don't have an account? Sign Up</div>
      <div id="signin-error" class="error-text"></div>
    </div>

    <!-- SIGN UP SCREEN -->
    <div id="screen-signup" class="glass-panel">
      <div class="ob-title">Create Account</div>
      <div class="ob-subtitle">Join the worldwide leaderboard</div>
      <input type="text" id="signup-name" class="ob-input" placeholder="Driver Name">
      <input type="email" id="signup-email" class="ob-input" placeholder="Email Address">
      <input type="password" id="signup-password" class="ob-input" placeholder="Password">
      <button class="ob-btn" onclick="signUp()">Register & Play</button>
      <div class="ob-link" onclick="switchScreen('screen-signin')">Already have an account? Sign In</div>
      <div id="signup-error" class="error-text"></div>
    </div>

  </div>

  <div id="desktop-ui">
    <div class="ui-title">Motion Control Mode</div>
    <div id="camera-preview">
      <video class="input-video"></video>
      <canvas class="output-canvas"></canvas>
    </div>
    <button id="hand-tracking-btn" class="btn-toggle">Enable</button>

    <div id="status-indicator">
      <div class="status-dot"></div>
      <span id="status-text">Hand Tracking OFF</span>
    </div>
  </div>

  <script>
    // Simple UI Flow logic
    function switchScreen(screenId) {
      document.querySelectorAll('.glass-panel').forEach(p => p.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    function startGameFlow() {
      // Fade out the entire onboarding UI
      const ui = document.getElementById('onboarding-ui');
      ui.style.opacity = '0';
      setTimeout(() => {
        ui.style.display = 'none';
        // Tell the 3D game to actually start running
        if (window.start3DGame) window.start3DGame();
      }, 800);
    }

    async function signIn() {
      const email = document.getElementById('signin-email').value;
      const password = document.getElementById('signin-password').value;
      const errorDiv = document.getElementById('signin-error');

      if (!email || !password) {
        errorDiv.textContent = 'Please fill in all fields';
        return;
      }

      errorDiv.textContent = '';
      try {
        const btn = document.querySelector('#screen-signin .ob-btn');
        const oldText = btn.textContent;
        btn.textContent = 'Loading...';

        const res = await fetch('/api/auth/signin', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email, password })
        });

        btn.textContent = oldText;
        const data = await res.json();

        if (!res.ok) {
          errorDiv.textContent = data.error || 'Sign in failed';
        } else {
          startGameFlow();
        }
      } catch (err) {
        errorDiv.textContent = 'Network error';
      }
    }

    async function signUp() {
      const name = document.getElementById('signup-name').value;
      const email = document.getElementById('signup-email').value;
      const password = document.getElementById('signup-password').value;
      const errorDiv = document.getElementById('signup-error');

      if (!email || !password || !name) {
        errorDiv.textContent = 'Please fill in all fields';
        return;
      }

      errorDiv.textContent = '';
      try {
        const btn = document.querySelector('#screen-signup .ob-btn');
        const oldText = btn.textContent;
        btn.textContent = 'Loading...';

        const res = await fetch('/api/auth/signup', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, email, password })
        });

        btn.textContent = oldText;
        const data = await res.json();

        if (!res.ok) {
          errorDiv.textContent = data.error || 'Sign up failed';
        } else {
          startGameFlow();
        }
      } catch (err) {
        errorDiv.textContent = 'Network error';
      }
    }
  </script>

  <script src="game.js"></script>
</body>

</html>